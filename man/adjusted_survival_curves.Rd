% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/adjusted_survival_curves.R
\name{adjusted_survival_curves}
\alias{adjusted_survival_curves}
\title{Generate covariate-adjusted survival predictions for Cox models}
\usage{
adjusted_survival_curves(grid, model, times = NULL)
}
\arguments{
\item{grid}{A data frame or tibble containing the scenarios to predict for.
Each row represents one covariate profile. Must contain all variables
used in the Cox model formula. Cannot be empty.}

\item{model}{A Cox proportional hazards model (coxph object) from the
survival package.}

\item{times}{Optional numeric vector of times at which to evaluate
predictions. All values must be positive (> 0). If NULL (default),
uses event times from the fitted model. Cannot be an empty vector.}
}
\value{
A data frame with survival predictions. Each row represents one
  combination of a grid scenario and evaluation time. Columns include:
  \describe{
    \item{Covariate columns}{All columns from grid are preserved}
    \item{time}{Evaluation time point}
    \item{n_risk}{Number at risk at this time}
    \item{n_event}{Number of events at this time}
    \item{estimate}{Predicted survival probability (0-1)}
    \item{std_error}{Standard error of survival estimate}
    \item{conf_low}{Lower confidence interval bound}
    \item{conf_high}{Upper confidence interval bound}
  }
  Rows are ordered by grid row, then by time within each scenario.
}
\description{
This function creates survival predictions for each scenario in a datagrid
using a Cox proportional hazards model. The predictions are "adjusted" in
that they account for the specific covariate values in each scenario,
producing conditional (covariate-specific) survival curves rather than
marginal (population-averaged) estimates.
}
\details{
The function processes each row of the grid independently, generating
a survival curve conditional on that row's covariate values. This is
accomplished by:
\enumerate{
  \item Splitting the grid into individual scenarios
  \item For each scenario, calling survival::survfit() with that row's covariates
  \item Extracting survival probabilities at specified or default times
  \item Combining results with original covariate values preserved
}

The resulting predictions show how survival varies across different
covariate profiles, making it useful for understanding model predictions
and communicating results to stakeholders.
}
\examples{
\dontrun{
# Fit a Cox model
library(survival)
data(lung)
lung_clean <- na.omit(lung[, c("time", "status", "age", "sex")])
cox_model <- coxph(Surv(time, status) ~ age + sex, data = lung_clean)

# Create prediction scenarios
library(dplyr)
pred_grid <- expand.grid(
  age = c(50, 60, 70),
  sex = c(1, 2)
)

# Generate adjusted survival predictions
predictions <- adjusted_survival_curves(
  grid = pred_grid,
  model = cox_model
)

# Predict at specific times
predictions_at_times <- adjusted_survival_curves(
  grid = pred_grid,
  model = cox_model,
  times = c(100, 200, 300, 400, 500)
)

# Visualize
library(ggplot2)
ggplot(predictions, aes(x = time, y = estimate,
                        color = factor(age),
                        linetype = factor(sex))) +
  geom_line() +
  geom_ribbon(aes(ymin = conf_low, ymax = conf_high, fill = factor(age)),
              alpha = 0.2) +
  labs(title = "Adjusted Survival Curves by Age and Sex",
       y = "Survival Probability",
       x = "Time") +
  theme_minimal()
}

}
